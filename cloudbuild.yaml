# cloudbuild.yaml
# This file defines the Continuous Integration/Continuous Deployment (CI/CD) pipeline
# for our data ingestion Cloud Function.
# Google Cloud Build will execute these steps automatically when triggered by a push to the GitHub repository.

steps:
# STEP 1: Enable required APIs for the deployment to succeed.
# This ensures the Eventarc API (used for Gen2 function triggers) is active.
- name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
  entrypoint: 'gcloud'
  args:
    - 'services'
    - 'enable'
    - 'eventarc.googleapis.com'
    - '--project=${PROJECT_ID}'

# STEP 2: Create the Pub/Sub topic that will trigger the function.
# The function deployment will fail if its trigger topic does not exist.
# This step explicitly creates the topic to ensure the next step can succeed.
# The command is idempotent; running it again if the topic exists will not cause an error.
- name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
  entrypoint: 'gcloud'
  args:
    - 'pubsub'
    - 'topics'
    - 'create'
    - '${_TRIGGER_TOPIC}'
    - '--project=${PROJECT_ID}'

# STEP 3: Deploy the Cloud Function.
# This step now runs after APIs are enabled and the trigger topic is confirmed to exist.
- name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
  entrypoint: 'gcloud'
  args:
    - 'functions'
    - 'deploy'
    - 'ingest-daily-data' # The name we are giving our Cloud Function
    - '--gen2' # Use the modern 2nd generation Cloud Functions environment
    - '--region=${_GCP_REGION}' # The GCP region for deployment (e.g., 'us-central1')
    - '--runtime=python311' # Specify the Python 3.11 runtime
    - '--source=./data_ingestion' # The directory containing the function's code
    - '--trigger-topic=${_TRIGGER_TOPIC}' # The Pub/Sub topic that will trigger this function
    - '--entry-point=ingest_daily_data' # The name of the Python function to execute
    - '--set-env-vars'
    - '^##^GCP_PROJECT_ID=${PROJECT_ID}##PUB_SUB_TOPIC=${_PUB_SUB_TOPIC}##ALPACA_SECRET_NAME=${_ALPACA_SECRET_NAME}'
  # Use a special delimiter '##' for environment variables to handle them as a single argument.

# --- Substitutions ---
# These are variables that we can set in our Cloud Build Trigger configuration.
# This allows us to change settings without editing this file.
substitutions:
  _GCP_REGION: 'us-central1'
  _TRIGGER_TOPIC: 'run-daily-ingestion' # A new topic to trigger the function on a schedule
  _PUB_SUB_TOPIC: 'daily-bars-raw' # The topic where the function will publish data
  _ALPACA_SECRET_NAME: 'projects/${PROJECT_NUMBER}/secrets/alpaca-api-keys/versions/latest' # IMPORTANT: You must replace ${PROJECT_NUMBER} with your actual GCP project number.

# --- Build Options ---
# This section configures the behavior of the build itself.
options:
  # This setting tells Cloud Build to store logs directly in Google Cloud Logging
  # and not in a separate Cloud Storage bucket. This resolves the permission error.
  logging: CLOUD_LOGGING_ONLY
