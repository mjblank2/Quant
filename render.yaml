services:
      # -----------------------------
      # Redis Service (Task Queue)
      # -----------------------------
      - type: redis
        name: quant-redis
        ipAllowList: []
        plan: standard  # Use 'standard' for production

      # -----------------------------
      # Web UI (interactive Streamlit)
      # -----------------------------
      - type: web
        name: smallcap-quant
        runtime: docker
        dockerfilePath: Dockerfile
        healthCheckPath: /health
        envVars:
          - key: SERVICE
            value: web
          - key: APP_MODE
            value: operator      # run app.py instead of dashboard.py
          - key: PORT
            value: "10000"
          - key: DATABASE_URL
            sync: false
          - key: REDIS_URL
            fromService:
              type: redis
              name: quant-redis
              property: connectionString
          - key: CELERY_BROKER_URL
            fromService:
              type: redis
              name: quant-redis
              property: connectionString
          - key: CELERY_RESULT_BACKEND
            fromService:
              type: redis
              name: quant-redis
              property: connectionString
          - key: APCA_API_KEY_ID
            sync: false
          - key: APCA_API_SECRET_KEY
            sync: false
          - key: APCA_API_BASE_URL
            value: https://api.alpaca.markets   # live base URL
          - key: ALPACA_DATA_FEED
            value: sip                          # use 'iex' if you don't have SIP entitlement
          - key: POLYGON_API_KEY
            sync: false
          - key: TIINGO_API_KEY
            sync: false
          - key: PYTHONPATH
            value: /app

      # -----------------------------
      # Data Ingestion API Service
      # -----------------------------
      - type: web
        name: data-ingestion-service
        runtime: docker
        dockerfilePath: Dockerfile
        healthCheckPath: /health
        envVars:
          - key: SERVICE
            value: web
          - key: APP_MODE
            value: api
          - key: DATABASE_URL
            sync: false
          - key: REDIS_URL
            fromService:
              type: redis
              name: quant-redis
              property: connectionString
          - key: CELERY_BROKER_URL
            fromService:
              type: redis
              name: quant-redis
              property: connectionString
          - key: CELERY_RESULT_BACKEND
            fromService:
              type: redis
              name: quant-redis
              property: connectionString
          - key: APCA_API_KEY_ID
            sync: false
          - key: APCA_API_SECRET_KEY
            sync: false
          - key: APCA_API_BASE_URL
            value: https://api.alpaca.markets
          - key: ALPACA_DATA_FEED
            value: sip
          - key: POLYGON_API_KEY
            sync: false
          - key: TIINGO_API_KEY
            sync: false
          - key: PYTHONPATH
            value: /app

      # -----------------------------
      # Worker (on-demand compute)
      # -----------------------------
      - type: worker
        name: quant-worker
        runtime: docker
        dockerfilePath: Dockerfile
        envVars:
          - key: SERVICE
            value: worker
          - key: WORKER_TASK
            value: idle
          - key: PYTHONPATH
            value: /app
          - key: DATABASE_URL
            sync: false
          - key: REDIS_URL
            fromService:
              type: redis
              name: quant-redis
              property: connectionString
          - key: CELERY_BROKER_URL
            fromService:
              type: redis
              name: quant-redis
              property: connectionString
          - key: CELERY_RESULT_BACKEND
            fromService:
              type: redis
              name: quant-redis
              property: connectionString
          - key: APCA_API_KEY_ID
            sync: false
          - key: APCA_API_SECRET_KEY
            sync: false
          - key: APCA_API_BASE_URL
            value: https://api.alpaca.markets
          - key: ALPACA_DATA_FEED
            value: sip
          - key: POLYGON_API_KEY
            sync: false
          - key: TIINGO_API_KEY
            sync: false

      # ---------------------------------------------------------
      # Cron: refresh universe
      # ---------------------------------------------------------
      - type: cron
        name: refresh-universe
        runtime: docker
        dockerfilePath: Dockerfile
        schedule: "0 14 * * 1"
        dockerCommand: bash -lc "scripts/cron_universe.sh"
        envVars:
          - key: SERVICE
            value: cron
          - key: DATABASE_URL
            sync: false
          - key: APCA_API_KEY_ID
            sync: false
          - key: APCA_API_SECRET_KEY
            sync: false
          - key: APCA_API_BASE_URL
            value: https://api.alpaca.markets
          - key: ALPACA_DATA_FEED
            value: sip
          - key: POLYGON_API_KEY
            sync: false
          - key: TIINGO_API_KEY
            sync: false
          - key: PYTHONPATH
            value: /app
          - key: ADV_USD_MIN
            value: "-1"

      # --------------------------------------------------------------
      # Cron: ingest recent bars
      # --------------------------------------------------------------
      - type: cron
        name: ingest-recent
        runtime: docker
        dockerfilePath: Dockerfile
        schedule: "45 21 * * 1-5"
        dockerCommand: bash -lc "scripts/cron_ingest.sh"
        envVars:
          - key: SERVICE
            value: cron
          - key: DATABASE_URL
            sync: false
          - key: APCA_API_KEY_ID
            sync: false
          - key: APCA_API_SECRET_KEY
            sync: false
          - key: APCA_API_BASE_URL
            value: https://api.alpaca.markets
          - key: ALPACA_DATA_FEED
            value: sip
          - key: POLYGON_API_KEY
            sync: false
          - key: TIINGO_API_KEY
            sync: false
          - key: PYTHONPATH
            value: /app

      # --------------------------------------------------------------
      # Cron: full EOD pipeline
      # --------------------------------------------------------------
      - type: cron
        name: eod-pipeline
        runtime: docker
        dockerfilePath: Dockerfile
        schedule: "30 22 * * 1-5"
        dockerCommand: bash -lc "scripts/cron_eod_pipeline.sh"
        envVars:
          - key: SERVICE
            value: cron
          - key: DATABASE_URL
            sync: false
          - key: APCA_API_KEY_ID
            sync: false
          - key: APCA_API_SECRET_KEY
            sync: false
          - key: APCA_API_BASE_URL
            value: https://api.alpaca.markets
          - key: ALPACA_DATA_FEED
            value: sip
          - key: POLYGON_API_KEY
            sync: false
          - key: TIINGO_API_KEY
            sync: false
          - key: PYTHONPATH
            value: /app
          # Optional model controls:
          # - key: BLEND_WEIGHTS
          #   value: "xgb:0.5,rf:0.3,ridge:0.2"
          # - key: REGIME_GATING
          #   value: "true"

      # ---------------------------------------------------------------------
      # Cron: high-frequency bar ingestion
      # ---------------------------------------------------------------------
      - type: cron
        name: ingest-frequent
        runtime: docker
        dockerfilePath: Dockerfile
        schedule: "*/5 * * * *"
        dockerCommand: bash -lc "scripts/cron_ingest.sh"
        envVars:
          - key: SERVICE
            value: cron
          - key: DATABASE_URL
            sync: false
          - key: APCA_API_KEY_ID
            sync: false
          - key: APCA_API_SECRET_KEY
            sync: false
          - key: APCA_API_BASE_URL
            value: https://api.alpaca.markets
          - key: ALPACA_DATA_FEED
            value: sip
          - key: POLYGON_API_KEY
            sync: false
          - key: TIINGO_API_KEY
            sync: false
          - key: PYTHONPATH
            value: /app

